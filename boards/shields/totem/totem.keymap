#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/outputs.h>

#define BASE  0
#define LAY1  1
#define LAY2  2
#define ADJ   3
#define GAME  4

#define TAP_TIMEOUT 170
#define QUICK_TAP_MS 100

#define KEYS_L 0 1 2 3 4 10 11 12 13 14 20 21 22 23 24 25 32 33 34
#define KEYS_R 5 6 7 8 9 15 16 17 18 19 26 27 28 29 30 31 35 36 37

&mt {
  flavor = "tap-preferred";
  global-quick-tap;
  quick-tap-ms = <QUICK_TAP_MS>;
  tapping-term-ms = <TAP_TIMEOUT>;
};

/ {
    behaviors {
      hm: homerow_mods {
        compatible = "zmk,behavior-hold-tap";
        label = "homerow mods";
        #binding-cells = <2>;
        flavor = "balanced";
        tapping-term-ms = <TAP_TIMEOUT>;
        quick-tap-ms = <QUICK_TAP_MS>;
        require-prior-idle-ms = <75>;
        bindings = <&kp>, <&kp>;
      };
      hml: homerow_mods_left {
        compatible = "zmk,behavior-hold-tap";
        label = "homerow mods left";
        #binding-cells = <2>;
        flavor = "balanced";
        tapping-term-ms = <TAP_TIMEOUT>;
        quick-tap-ms = <QUICK_TAP_MS>;
        require-prior-idle-ms = <75>;
        bindings = <&kp>, <&kp>;
        hold-trigger-key-positions = <KEYS_R>;
        hold-trigger-on-release;
      };
      hmr: homerow_mods_right {
        compatible = "zmk,behavior-hold-tap";
        label = "homerow mods right";
        #binding-cells = <2>;
        flavor = "balanced";
        tapping-term-ms = <TAP_TIMEOUT>;
        quick-tap-ms = <QUICK_TAP_MS>;
        require-prior-idle-ms = <75>;
        bindings = <&kp>, <&kp>;
        hold-trigger-key-positions = <KEYS_L>;
        hold-trigger-on-release;
      };
    };
    combos {
      compatible = "zmk,combos";
      combo_caps_word {
        timeout-ms = <50>;
        key-positions = <20 31>; // TAB+APOS
        bindings = <&caps_word>;
      };
      combo_esc {
        timeout-ms = <50>;
        key-positions = <0 1>; // Q+W
        bindings = <&kp ESC>;
      };
    };

//             ┏━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┓   ┏━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┓
//             ┃     Q     ┃     W     ┃     E     ┃     R     ┃     T     ┃   ┃     Y     ┃     U     ┃     I     ┃     P     ┃     O     ┃
//             ┣━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━┫   ┣━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━┫
//             ┃     A     ┃     S     ┃     D     ┃     F     ┃     G     ┃   ┃     H     ┃     J     ┃     K     ┃     L     ┃     ;     ┃
// ┏━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━┫   ┣━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━┓
// ┃     TAB   ┃     Z     ┃     X     ┃     C     ┃     V     ┃     B     ┃   ┃     M     ┃     N     ┃     ,     ┃     .     ┃     /     ┃     '     ┃
// ┗━━━━━━━━━━━┻━━━━━━━━━━━┻━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━┫   ┣━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━╋━━━━━━━━━━━┻━━━━━━━━━━━┻━━━━━━━━━━━┛
//                                     ┃           ┃    ESC    ┃    SPC    ┃   ┃   BSPC    ┃   ENTER   ┃           ┃
//                                     ┗━━━━━━━━━━━┻━━━━━━━━━━━┻━━━━━━━━━━━┛   ┗━━━━━━━━━━━┻━━━━━━━━━━━┻━━━━━━━━━━━┛

    keymap {
      compatible = "zmk,keymap";
      base_layer {
        label= "BASE";
        bindings = <
// ╷           ╷           ╷           ╷           ╷           ╷           ╷   ╷           ╷           ╷           ╷           ╷           ╷           ╷
               &kp Q       &kp W       &kp E       &kp R       &kp T           &kp Y       &kp U       &kp I       &kp O       &kp P
               &hml LCTRL A &hml LSHFT S &hml LALT D &hml LGUI F &kp G         &kp H       &hmr RGUI J &hmr RALT K &hmr RSHFT L &hmr RCTRL SEMI
    &kp TAB    &kp Z       &kp X       &kp C       &kp V        &kp B          &kp N       &kp M       &kp COMMA   &kp DOT     &kp FSLH    &kp APOS
                                       &kp LGUI    &lt LAY1 ESC &kp SPACE      &kp BSPC    &lt LAY2 ENTER &kp RGUI
        >;
      };

      nav_layer {
        label= "LAY1";
        bindings = <
// ╷           ╷           ╷           ╷           ╷           ╷           ╷   ╷           ╷           ╷           ╷           ╷           ╷           ╷
                &kp N1     &kp N2     &kp N3      &kp N4     &kp N5            &kp N6      &kp N7      &kp N8      &kp N9      &kp N0
                &kp EXCL   &kp AT     &kp HASH    &kp DLLR   &kp PRCNT         &kp LEFT    &kp DOWN    &kp UP      &kp RIGHT   &kp KP_PLUS
    &trans      &kp TILDE  &kp UNDER  &kp MINUS   &kp BSLH   &kp PIPE          &trans      &kp KP_PLUS &kp EQUAL   &trans      &trans      &kp EQUAL
                                      &trans      &kp ESC    &trans            &trans      &mo ADJ     &to GAME
        >;
      };

      sim_layer {
        label= "LAY2"; 
        bindings = <
// ╷           ╷           ╷           ╷           ╷           ╷           ╷   ╷           ╷           ╷           ╷           ╷           ╷           ╷
                &kp N1     &kp N2     &kp N3      &kp N4     &kp N5            &kp N6      &kp N7      &kp N8      &kp N9      &kp N0
                &kp EXCL   &kp AT     &kp HASH    &kp DLLR   &kp PRCNT         &kp CARET   &kp AMPS    &kp STAR    &kp LPAR    &kp RPAR
    &trans      &kp TILDE  &kp UNDER  &kp MINUS   &kp BSLH   &kp PIPE          &kp GRAVE   &kp LBRC    &kp RBRC    &kp LBKT    &kp RBKT    &kp EQUAL
                                      &trans      &mo ADJ    &trans            &trans      &trans      &trans
        >;
      };

      adjust_layer {
        label= "ADJ";
        bindings = <
// ╷           ╷           ╷           ╷           ╷           ╷           ╷   ╷           ╷           ╷           ╷           ╷           ╷           ╷
                &sys_reset  &bt BT_CLR &out OUT_TOG &trans      &trans         &trans      &kp F7      &kp F8      &kp F9      &kp F12
                &bootloader &bt BT_NXT &trans       &trans      &trans         &trans      &kp F4      &kp F5      &kp F6      &kp F11
   &trans      &trans       &bt BT_PRV &trans       &trans      &trans         &trans      &kp F1      &kp F2      &kp F3      &kp F10     &trans
                                       &trans       &trans      &trans         &trans      &trans      &trans
        >;
      };

      game_layer {
        label= "GAME";
        bindings = <
// ╷           ╷           ╷           ╷           ╷           ╷           ╷   ╷           ╷           ╷           ╷           ╷           ╷           ╷
                &none      &none       &kp W       &none       &none           &none       &none       &none       &none       &none
                &kp LSHFT  &kp A       &kp S       &kp D       &none           &none       &kp X       &kp Y       &none       &kp RSHFT
    &kp TAB     &kp LCTRL  &none       &none       &none        &none          &none       &none       &none       &none       &kp RCTRL   &none
                                       &kp ESC     &none       &kp SPACE       &kp BSPC    &kp ENTER   &to BASE
        >;
      };


      extra_layer {
        label= "EXTRA";
        bindings = <
// ╷           ╷           ╷           ╷           ╷           ╷           ╷   ╷           ╷           ╷           ╷           ╷           ╷           ╷
               &trans      &trans      &trans      &trans      &trans          &trans      &trans      &trans      &trans      &trans
               &trans      &trans      &trans      &trans      &trans          &trans      &trans      &trans      &trans      &trans
   &trans      &trans      &trans      &trans      &trans      &trans          &trans      &trans      &trans      &trans      &trans      &trans
                                       &trans      &trans      &trans          &trans      &trans      &trans
        >;
      };
    };
};
